{"version":3,"file":"OrganizationModal-55458df4.js","sources":["../../../../frontend/src/components/Modals/OrganizationModal.vue"],"sourcesContent":["<template>\n  <Dialog v-model=\"show\" :options=\"{ size: 'xl' }\">\n    <template #body>\n      <div class=\"px-4 pt-5 pb-6 bg-surface-modal sm:px-6\">\n        <div class=\"flex items-center justify-between mb-5\">\n          <div>\n            <h3 class=\"text-2xl font-semibold leading-6 text-ink-gray-9\">\n              {{ __('New Organization') }}\n            </h3>\n          </div>\n          <div class=\"flex items-center gap-1\">\n            <Button\n              v-if=\"isManager() && !isMobileView\"\n              variant=\"ghost\"\n              class=\"w-7\"\n              :tooltip=\"__('Edit fields layout')\"\n              :icon=\"EditIcon\"\n              @click=\"openQuickEntryModal\"\n            />\n            <Button\n              variant=\"ghost\"\n              class=\"w-7\"\n              @click=\"show = false\"\n              icon=\"x\"\n            />\n          </div>\n        </div>\n        <FieldLayout\n          v-if=\"tabs.data?.length\"\n          :tabs=\"tabs.data\"\n          :data=\"organization.doc\"\n          doctype=\"CRM Organization\"\n        />\n        <ErrorMessage class=\"mt-8\" v-if=\"error\" :message=\"__(error)\" />\n      </div>\n      <div class=\"px-4 pt-4 pb-7 sm:px-6\">\n        <div class=\"space-y-2\">\n          <Button\n            class=\"w-full\"\n            variant=\"solid\"\n            :label=\"__('Create')\"\n            :loading=\"loading\"\n            @click=\"createOrganization\"\n          />\n        </div>\n      </div>\n    </template>\n  </Dialog>\n</template>\n\n<script setup>\nimport FieldLayout from '@/components/FieldLayout/FieldLayout.vue'\nimport EditIcon from '@/components/Icons/EditIcon.vue'\nimport { usersStore } from '@/stores/users'\nimport { isMobileView } from '@/composables/settings'\nimport {\n  showQuickEntryModal,\n  quickEntryProps,\n  showAddressModal,\n  addressProps,\n} from '@/composables/modals'\nimport { useDocument } from '@/data/document'\nimport { capture } from '@/telemetry'\nimport { call, FeatherIcon, createResource } from 'frappe-ui'\nimport { ref, nextTick, onMounted } from 'vue'\nimport { useRouter } from 'vue-router'\n\nconst props = defineProps({\n  data: {\n    type: Object,\n    default: () => ({}),\n  },\n  options: {\n    type: Object,\n    default: {\n      redirect: true,\n      afterInsert: () => {},\n    },\n  },\n})\n\nconst { isManager } = usersStore()\n\nconst router = useRouter()\nconst show = defineModel()\n\nconst loading = ref(false)\nconst error = ref(null)\n\nconst { document: organization, triggerOnBeforeCreate } =\n  useDocument('CRM Organization')\n\nasync function createOrganization() {\n  loading.value = true\n  error.value = null\n\n  await triggerOnBeforeCreate?.()\n\n  const doc = await call(\n    'frappe.client.insert',\n    {\n      doc: {\n        doctype: 'CRM Organization',\n        ...organization.doc,\n      },\n    },\n    {\n      onError: (err) => {\n        if (err.error.exc_type == 'ValidationError') {\n          error.value = err.error?.messages?.[0]\n          loading.value = false\n        }\n      },\n    },\n  )\n  loading.value = false\n  if (doc.name) {\n    capture('organization_created')\n    handleOrganizationUpdate(doc)\n  }\n}\n\nfunction handleOrganizationUpdate(doc) {\n  if (doc.name && props.options.redirect) {\n    router.push({\n      name: 'Organization',\n      params: { organizationId: doc.name },\n    })\n  }\n  show.value = false\n  props.options.afterInsert && props.options.afterInsert(doc)\n}\n\nconst tabs = createResource({\n  url: 'crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout',\n  cache: ['QuickEntry', 'CRM Organization'],\n  params: { doctype: 'CRM Organization', type: 'Quick Entry' },\n  auto: true,\n  transform: (_tabs) => {\n    return _tabs.forEach((tab) => {\n      tab.sections.forEach((section) => {\n        section.columns.forEach((column) => {\n          column.fields.forEach((field) => {\n            if (field.fieldname == 'address') {\n              field.create = (value, close) => {\n                organization.doc.address = value\n                openAddressModal()\n                close()\n              }\n              field.edit = (address) => openAddressModal(address)\n            } else if (field.fieldtype === 'Table') {\n              organization.doc[field.fieldname] = []\n            }\n          })\n        })\n      })\n    })\n  },\n})\n\nonMounted(() => {\n  organization.doc = { no_of_employees: '1-10' }\n  Object.assign(organization.doc, props.data)\n})\n\nfunction openQuickEntryModal() {\n  showQuickEntryModal.value = true\n  quickEntryProps.value = { doctype: 'CRM Organization' }\n  nextTick(() => (show.value = false))\n}\n\nfunction openAddressModal(_address) {\n  showAddressModal.value = true\n  addressProps.value = {\n    doctype: 'Address',\n    address: _address,\n  }\n}\n</script>\n"],"names":["props","__props","isManager","usersStore","router","useRouter","show","_useModel","loading","ref","error","organization","triggerOnBeforeCreate","useDocument","createOrganization","doc","call","err","_b","_a","capture","handleOrganizationUpdate","tabs","createResource","_tabs","tab","section","column","field","value","close","openAddressModal","address","onMounted","openQuickEntryModal","showQuickEntryModal","quickEntryProps","nextTick","_address","showAddressModal","addressProps","_createBlock","_component_Dialog","$event","_createElementVNode","_hoisted_1","_hoisted_2","_hoisted_3","_toDisplayString","__","_hoisted_4","_unref","isMobileView","_component_Button","EditIcon","_createVNode","FieldLayout","_component_ErrorMessage","_hoisted_5","_hoisted_6"],"mappings":"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"}