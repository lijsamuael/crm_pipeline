{"version":3,"file":"LeadModal-26229f4d.js","sources":["../../../../frontend/src/components/Modals/LeadModal.vue"],"sourcesContent":["<template>\n  <Dialog v-model=\"show\" :options=\"{ size: '3xl' }\">\n    <template #body>\n      <div class=\"bg-surface-modal px-4 pb-6 pt-5 sm:px-6\">\n        <div class=\"mb-5 flex items-center justify-between\">\n          <div>\n            <h3 class=\"text-2xl font-semibold leading-6 text-ink-gray-9\">\n              {{ __('Create Lead') }}\n            </h3>\n          </div>\n          <div class=\"flex items-center gap-1\">\n            <Button\n              v-if=\"isManager() && !isMobileView\"\n              variant=\"ghost\"\n              class=\"w-7\"\n              :tooltip=\"__('Edit fields layout')\"\n              :icon=\"EditIcon\"\n              @click=\"openQuickEntryModal\"\n            />\n            <Button\n              variant=\"ghost\"\n              class=\"w-7\"\n              @click=\"show = false\"\n              icon=\"x\"\n            />\n          </div>\n        </div>\n        <div>\n          <FieldLayout v-if=\"tabs.data\" :tabs=\"tabs.data\" :data=\"lead.doc\" />\n          <ErrorMessage class=\"mt-4\" v-if=\"error\" :message=\"__(error)\" />\n        </div>\n      </div>\n      <div class=\"px-4 pb-7 pt-4 sm:px-6\">\n        <div class=\"flex flex-row-reverse gap-2\">\n          <Button\n            variant=\"solid\"\n            :label=\"__('Create')\"\n            :loading=\"isLeadCreating\"\n            @click=\"createNewLead\"\n          />\n        </div>\n      </div>\n    </template>\n  </Dialog>\n</template>\n\n<script setup>\nimport EditIcon from '@/components/Icons/EditIcon.vue'\nimport FieldLayout from '@/components/FieldLayout/FieldLayout.vue'\nimport { usersStore } from '@/stores/users'\nimport { statusesStore } from '@/stores/statuses'\nimport { sessionStore } from '@/stores/session'\nimport { isMobileView } from '@/composables/settings'\nimport { showQuickEntryModal, quickEntryProps } from '@/composables/modals'\nimport { capture } from '@/telemetry'\nimport { createResource } from 'frappe-ui'\nimport { useOnboarding } from 'frappe-ui/frappe'\nimport { useDocument } from '@/data/document'\nimport { computed, onMounted, ref, nextTick } from 'vue'\nimport { useRouter } from 'vue-router'\n\nconst props = defineProps({\n  defaults: Object,\n})\n\nconst { user } = sessionStore()\nconst { getUser, isManager } = usersStore()\nconst { getLeadStatus, statusOptions } = statusesStore()\nconst { updateOnboardingStep } = useOnboarding('frappecrm')\n\nconst show = defineModel()\nconst router = useRouter()\nconst error = ref(null)\nconst isLeadCreating = ref(false)\n\nconst { document: lead, triggerOnBeforeCreate } = useDocument('CRM Lead')\n\nconst leadStatuses = computed(() => {\n  let statuses = statusOptions('lead')\n  if (!lead.doc.status) {\n    lead.doc.status = statuses?.[0]?.value\n  }\n  return statuses\n})\n\nconst tabs = createResource({\n  url: 'crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout',\n  cache: ['QuickEntry', 'CRM Lead'],\n  params: { doctype: 'CRM Lead', type: 'Quick Entry' },\n  auto: true,\n  transform: (_tabs) => {\n    return _tabs.forEach((tab) => {\n      tab.sections.forEach((section) => {\n        section.columns.forEach((column) => {\n          column.fields.forEach((field) => {\n            if (field.fieldname == 'status') {\n              field.fieldtype = 'Select'\n              field.options = leadStatuses.value\n              field.prefix = getLeadStatus(lead.doc.status).color\n            }\n\n            if (field.fieldtype === 'Table') {\n              lead.doc[field.fieldname] = []\n            }\n          })\n        })\n      })\n    })\n  },\n})\n\nconst createLead = createResource({\n  url: 'frappe.client.insert',\n})\n\nasync function createNewLead() {\n  if (lead.doc.website && !lead.doc.website.startsWith('http')) {\n    lead.doc.website = 'https://' + lead.doc.website\n  }\n\n  await triggerOnBeforeCreate?.()\n\n  createLead.submit(\n    {\n      doc: {\n        doctype: 'CRM Lead',\n        ...lead.doc,\n      },\n    },\n    {\n      validate() {\n        error.value = null\n        if (!lead.doc.first_name) {\n          error.value = __('First Name is mandatory')\n          return error.value\n        }\n        if (lead.doc.annual_revenue) {\n          if (typeof lead.doc.annual_revenue === 'string') {\n            lead.doc.annual_revenue = lead.doc.annual_revenue.replace(/,/g, '')\n          } else if (isNaN(lead.doc.annual_revenue)) {\n            error.value = __('Annual Revenue should be a number')\n            return error.value\n          }\n        }\n        if (\n          lead.doc.mobile_no &&\n          isNaN(lead.doc.mobile_no.replace(/[-+() ]/g, ''))\n        ) {\n          error.value = __('Mobile No should be a number')\n          return error.value\n        }\n        if (lead.doc.email && !lead.doc.email.includes('@')) {\n          error.value = __('Invalid Email')\n          return error.value\n        }\n        if (!lead.doc.status) {\n          error.value = __('Status is required')\n          return error.value\n        }\n        isLeadCreating.value = true\n      },\n      onSuccess(data) {\n        capture('lead_created')\n        isLeadCreating.value = false\n        show.value = false\n        router.push({ name: 'Lead', params: { leadId: data.name } })\n        updateOnboardingStep('create_first_lead', true, false, () => {\n          localStorage.setItem('firstLead' + user, data.name)\n        })\n      },\n      onError(err) {\n        isLeadCreating.value = false\n        if (!err.messages) {\n          error.value = err.message\n          return\n        }\n        error.value = err.messages.join('\\n')\n      },\n    },\n  )\n}\n\nfunction openQuickEntryModal() {\n  showQuickEntryModal.value = true\n  quickEntryProps.value = { doctype: 'CRM Lead' }\n  nextTick(() => (show.value = false))\n}\n\nonMounted(() => {\n  lead.doc = { no_of_employees: '1-10' }\n  Object.assign(lead.doc, props.defaults)\n\n  if (!lead.doc?.lead_owner) {\n    lead.doc.lead_owner = getUser().name\n  }\n  if (!lead.doc?.status && leadStatuses.value[0]?.value) {\n    lead.doc.status = leadStatuses.value[0].value\n  }\n})\n</script>\n"],"names":["props","__props","user","sessionStore","getUser","isManager","usersStore","getLeadStatus","statusOptions","statusesStore","updateOnboardingStep","useOnboarding","show","_useModel","router","useRouter","error","ref","isLeadCreating","lead","triggerOnBeforeCreate","useDocument","leadStatuses","computed","statuses","_a","tabs","createResource","_tabs","tab","section","column","field","createLead","createNewLead","data","capture","err","openQuickEntryModal","showQuickEntryModal","quickEntryProps","nextTick","onMounted","_b","_c","_createBlock","_component_Dialog","$event","_createElementVNode","_hoisted_1","_hoisted_2","_hoisted_3","_toDisplayString","__","_hoisted_4","_unref","isMobileView","_component_Button","EditIcon","_createVNode","FieldLayout","_component_ErrorMessage","_hoisted_5","_hoisted_6"],"mappings":"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"}