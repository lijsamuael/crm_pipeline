[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CRM Lead",
  "enabled": 1,
  "modified": "2025-10-01 09:33:45.495852",
  "module": "CRM Pipeline",
  "name": "Convert Lead to Pipeline",
  "script": "frappe.ui.form.on('CRM Lead', {\n    refresh(frm) {\n        frm.add_custom_button(__('Create Pipeline'), function () {\n            frappe.call({\n                method: \"crm_pipeline.api.create_pipeline_from_lead\",\n                args: {\n                    lead_name: frm.doc.name\n                },\n                callback: function (r) {\n                    if (!r.exc && r.message) {\n                        // create link to the new Pipeline document\n                        let pipeline_link = frappe.utils.get_form_link('CRM Pipeline', r.message);\n\n                        frappe.msgprint({\n                            title: __('Success'),\n                            message: __('Pipeline created successfully: <a href=\"{0}\">{1}</a>', [pipeline_link, r.message]),\n                            indicator: 'green'\n                        });\n\n                        frm.reload_doc();\n                    }\n                }\n            });\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CRM Pipeline",
  "enabled": 1,
  "modified": "2025-10-01 13:17:53.756684",
  "module": null,
  "name": "Status Change for Pipline",
  "script": "frappe.ui.form.on('CRM Pipeline', {\n    onload: function(frm) {\n        // store initial status to detect changes later\n        frm.__last_status = frm.doc.status;\n    },\n\n    validate: function(frm) {\n        console.log(\"Status on validate:\", frm.doc.status, \"Last status:\", frm.__last_status);\n\n        // Skip if no change in status\n        if (frm.doc.status === frm.__last_status) {\n            return;\n        }\n\n        let new_status = frm.doc.status;\n\n        // Close last log if open\n        if (frm.doc.logs && frm.doc.logs.length > 0) {\n            let last_log = frm.doc.logs[frm.doc.logs.length - 1];\n            if (!last_log.to_status) {\n                last_log.to_status = new_status;\n                last_log.to_date = frappe.datetime.now_datetime();\n\n                if (last_log.from_date) {\n                    let diff_seconds = moment(last_log.to_date).diff(moment(last_log.from_date), 'seconds');\n                    last_log.duration = format_duration(diff_seconds);\n                } else {\n                    last_log.duration = \"0s\";\n                }\n            }\n        }\n\n        // Add a new log entry for the new current status\n        let new_log = frm.add_child(\"logs\");\n        new_log.from_status = new_status;\n        new_log.to_status = \"\";\n        new_log.from_date = frappe.datetime.now_datetime();\n        new_log.duration = \"0s\";\n\n        // Store last status for next change\n        frm.__last_status = new_status;\n\n        // Refresh child table field\n        frm.refresh_field(\"logs\");\n\n        frappe.show_alert(__('Pipeline logs updated for status: ' + new_status));\n    },\n\n    refresh: function(frm) {\n        frm.add_custom_button(__('Create Deal'), function() {\n            frappe.call({\n                method: \"crm_pipeline.api.create_deal_from_pipeline\",\n                args: {\n                    pipeline_name: frm.doc.name\n                },\n                callback: function (r) {\n                    if (!r.exc) {\n                        frappe.msgprint(__('Deal created successfully: ' + r.message));\n                        frm.reload_doc();\n                    }\n                }\n            });\n        });\n    }\n});\n\n// Helper: format duration in \"2h 3m 45s\"\nfunction format_duration(total_seconds) {\n    total_seconds = parseInt(total_seconds, 10);\n\n    let hours = Math.floor(total_seconds / 3600);\n    let minutes = Math.floor((total_seconds % 3600) / 60);\n    let seconds = total_seconds % 60;\n\n    let parts = [];\n    if (hours > 0) parts.push(hours + \"h\");\n    if (minutes > 0) parts.push(minutes + \"m\");\n    if (seconds > 0 || parts.length === 0) parts.push(seconds + \"s\");\n\n    return parts.join(\" \");\n}\n\n\n\n// Child table listener\nfrappe.ui.form.on('CRM Pipeline Items', {\n    est_qoutation_sales: function(frm, cdt, cdn) {\n        update_pipeline_sum(frm);\n    },\n    deal_value: function(frm, cdt, cdn){\n        update_pipeline_sum(frm);  \n    },\n    deals_remove: function(frm) {\n        update_pipeline_sum(frm);\n    }\n});\n\n// helper function\nfunction update_pipeline_sum(frm) {\n    console.log(\"event triggered\")\n    let total = 0;\n    let deal_total = 0;\n    (frm.doc.deals || []).forEach(row => {\n        if (row.est_qoutation_sales) {\n            total += flt(row.est_qoutation_sales);\n        }\n        if (row.deal_value) {\n            deal_total += flt(row.deal_value);\n        }\n    });\n    frm.set_value('est_pipeline_value', total);\n    frm.set_value('total_deal_value', deal_total);\n    frm.refresh_field('est_pipeline_value');\n    frm.refresh_field('total_deal_value');\n}\n",
  "view": "Form"
 }
]